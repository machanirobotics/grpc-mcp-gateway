# Code generated by protoc-gen-mcp. DO NOT EDIT.
# versions: protoc-gen-mcp v1.2.3+dirty
# source: todo/v1/todo_service.proto
# Build: make -C generated (from cpp/) or cd generated && make

CXX ?= g++
CXXFLAGS ?= -std=c++17 -O2 -Wall

GEN_DIR := .
RUST_DIR := $(GEN_DIR)/rust
# cpp project src/ is at ../../cpp/src relative to proto/generated/cpp
SRC_DIR := $(GEN_DIR)/../../cpp/src
CXX_INCLUDE := $(RUST_DIR)/target/cxx_include
RUST_LIB := $(RUST_DIR)/target/release/libtodo_v1_mcp_cpp.a

GRPC_CFLAGS := $(shell pkg-config --cflags grpc++ protobuf 2>/dev/null || echo "")
GRPC_LIBS := $(shell pkg-config --libs grpc++ protobuf 2>/dev/null || echo "")

PROTO_CC := $(shell find $(GEN_DIR) \( -name '*.pb.cc' -o -name '*.grpc.pb.cc' \) 2>/dev/null)
MCP_CC := $(shell find $(GEN_DIR) -name '*.mcp.cc' 2>/dev/null)
MAIN_GEN := $(GEN_DIR)/main.cc
HAS_USER_MAIN := $(wildcard $(SRC_DIR)/main.cc)
USER_CC := $(filter-out $(SRC_DIR)/main.cc,$(wildcard $(SRC_DIR)/*.cc))

GEN_SRCS := $(if $(HAS_USER_MAIN),,$(MAIN_GEN)) $(MCP_CC) $(PROTO_CC)
GEN_OBJS := $(patsubst $(GEN_DIR)/%.cc,$(GEN_DIR)/build/%.o,$(GEN_SRCS))
SRC_OBJS := $(patsubst $(SRC_DIR)/%.cc,$(GEN_DIR)/build/src/%.o,$(USER_CC))
SRC_OBJS += $(if $(HAS_USER_MAIN),$(GEN_DIR)/build/src/main.o,)
OBJS := $(GEN_OBJS) $(SRC_OBJS)

OBJ_DIR := $(GEN_DIR)/build
BINARY := server

.PHONY: all rust clean

all: rust $(BINARY)

rust:
	cd $(RUST_DIR) && cargo build --release

UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
  RUST_LDFLAGS := -framework CoreFoundation -framework Security -framework SystemConfiguration
else
  RUST_LDFLAGS :=
endif

$(BINARY): rust $(OBJS)
	$(CXX) $(CXXFLAGS) -o $@ $(OBJS) $(RUST_LIB) $(GRPC_LIBS) $(RUST_LDFLAGS) -lpthread -ldl

$(OBJ_DIR)/%.o: $(GEN_DIR)/%.cc
	@mkdir -p $(dir $@)
	$(CXX) $(CXXFLAGS) -I$(GEN_DIR) -I$(SRC_DIR) -I$(CXX_INCLUDE) $(GRPC_CFLAGS) -c -o $@ $<

$(OBJ_DIR)/src/%.o: $(SRC_DIR)/%.cc
	@mkdir -p $(dir $@)
	$(CXX) $(CXXFLAGS) -I$(GEN_DIR) -I$(SRC_DIR) -I$(CXX_INCLUDE) $(GRPC_CFLAGS) -c -o $@ $<

clean:
	rm -rf $(OBJ_DIR) $(BINARY)
	cd $(RUST_DIR) && cargo clean
