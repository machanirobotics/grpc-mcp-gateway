name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Validate tag matches semver
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Tag $TAG does not match semver pattern v*.*.*"
            exit 1
          fi
          echo "VERSION=$TAG" >> "$GITHUB_ENV"

      - name: Run tests
        run: |
          go test -race ./...
          cd plugin && go test -race ./...
          cd ../examples && go test -race ./...

      - name: Build binaries
        run: |
          mkdir -p dist
          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
            "windows/arm64"
          )
          for platform in "${platforms[@]}"; do
            GOOS="${platform%/*}"
            GOARCH="${platform#*/}"
            ext=""
            if [ "$GOOS" = "windows" ]; then ext=".exe"; fi
            output="protoc-gen-mcp-${VERSION}-${GOOS}-${GOARCH}${ext}"
            echo "Building $output..."
            GOOS=$GOOS GOARCH=$GOARCH go build -trimpath \
              -ldflags "-s -w -X main.version=${VERSION}" \
              -o "dist/${output}" \
              ./plugin/cmd/protoc-gen-mcp/
          done

      - name: Create archives
        run: |
          cd dist
          for f in protoc-gen-mcp-*; do
            if echo "$f" | grep -q windows; then
              zip "${f%.*}.zip" "$f"
            else
              tar czf "${f}.tar.gz" "$f"
            fi
          done
          sha256sum *.tar.gz *.zip > checksums.txt
          cat checksums.txt

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v' | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s|%h" HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s|%h" "${PREV_TAG}..HEAD")
          fi

          NEW="" UPDATED="" FIXED="" OTHER=""
          while IFS='|' read -r msg hash; do
            [ -z "$msg" ] && continue
            lower=$(echo "$msg" | tr '[:upper:]' '[:lower:]')
            case "$lower" in
              feat:*|feat\(*|add:*|add\ *)   NEW="${NEW}- ${msg} (\`${hash}\`)\n" ;;
              fix:*|fix\(*|bug:*|bugfix:*)    FIXED="${FIXED}- ${msg} (\`${hash}\`)\n" ;;
              refactor:*|refactor\(*|chore:*|chore\(*|docs:*|docs\(*|ci:*|ci\(*|style:*|perf:*|build:*)
                                              UPDATED="${UPDATED}- ${msg} (\`${hash}\`)\n" ;;
              *)                              OTHER="${OTHER}- ${msg} (\`${hash}\`)\n" ;;
            esac
          done <<< "$COMMITS"

          {
            echo "CHANGELOG<<EOF"
            [ -n "$NEW" ]     && printf "#### New\n${NEW}\n"
            [ -n "$UPDATED" ] && printf "#### Updated\n${UPDATED}\n"
            [ -n "$FIXED" ]   && printf "#### Bug Fixes\n${FIXED}\n"
            [ -n "$OTHER" ]   && printf "#### Other\n${OTHER}\n"
            [ -z "$NEW$UPDATED$FIXED$OTHER" ] && echo "Initial release"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Setup Buf CLI
        uses: bufbuild/buf-setup-action@v1

      - name: Push proto module to BSR
        run: cd proto && buf push --label "$VERSION"
        env:
          BUF_TOKEN: ${{ secrets.BUF_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.VERSION }}
          body: |
            ## grpc-mcp-gateway ${{ env.VERSION }}

            ### Installation

            **Go install (plugin):**
            ```bash
            go install github.com/machanirobotics/grpc-mcp-gateway/plugin/cmd/protoc-gen-mcp@${{ env.VERSION }}
            ```

            **Python (pre-compiled proto types):**
            ```bash
            pip install grpc-mcp-gateway-protos==${{ env.VERSION }}
            ```

            **Rust (pre-compiled proto types):**
            ```toml
            [dependencies]
            mcp-protobuf = "${{ env.VERSION }}"
            ```

            **Download binary:**
            Download the archive for your platform below, extract it, and place `protoc-gen-mcp` in your `$PATH`.

            The version is baked into the binary via `-ldflags` and will appear in all generated file headers:
            ```
            protoc-gen-mcp --version
            # protoc-gen-mcp ${{ env.VERSION }}
            ```

            ### Checksums
            See `checksums.txt` for SHA-256 hashes of all archives.

            ### Changes
            ${{ steps.changelog.outputs.CHANGELOG }}
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          generate_release_notes: false
          draft: false
          prerelease: false

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: release
    environment: release
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Stamp version from tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          sed -i "s/^version = .*/version = \"$VERSION\"/" mcp/protobuf/python/pyproject.toml

      - name: Build package
        run: |
          pip install build
          cd mcp/protobuf/python && python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: mcp/protobuf/python/dist/

  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: release
    environment: release
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - name: Stamp version from tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          sed -i "s/^version = .*/version = \"$VERSION\"/" mcp/protobuf/rust/Cargo.toml

      - name: Publish to crates.io
        working-directory: mcp/protobuf/rust
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  update-docs:
    name: Update docs with release version
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version in docs
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "Updating docs to version $VERSION"

          # Main README - mcp-protobuf Cargo version
          sed -i 's/mcp-protobuf = "[^"]*"/mcp-protobuf = "'"$VERSION"'"/' README.md

          # Python README - pip install version
          sed -i 's/grpc-mcp-gateway-protos==[0-9]\+\.[0-9]\+\.[0-9]\+/grpc-mcp-gateway-protos=='"$VERSION"'/' mcp/protobuf/python/README.md
          sed -i 's/v[0-9]\+\.[0-9]\+\.[0-9]\+/v'"$VERSION"'/' mcp/protobuf/python/README.md

          # Rust README - mcp-protobuf Cargo version
          sed -i 's/mcp-protobuf = "[^"]*"/mcp-protobuf = "'"$VERSION"'"/' mcp/protobuf/rust/README.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md mcp/protobuf/python/README.md mcp/protobuf/rust/README.md
          if git diff --staged --quiet; then
            echo "No doc changes needed"
          else
            git commit -m "docs: update version references to ${{ github.ref_name }}"
            git push
          fi
