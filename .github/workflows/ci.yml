name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint (Go)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - uses: golangci/golangci-lint-action@v7
        with:
          version: latest

  build:
    name: Build Plugin
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [darwin, linux]
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Build protoc-gen-mcp
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: go build -ldflags "-s -w" -o /dev/null ./plugin/cmd/protoc-gen-mcp/

  test:
    name: Test (Go)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Test all modules
        run: |
          go test ./...
          cd plugin && go test ./...
          cd ../examples && go test ./...

  python:
    name: Check (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: astral-sh/setup-uv@v4
      - name: Install & verify imports
        working-directory: examples/python
        run: |
          uv sync
          uv run python -c "
          import sys, os
          sys.path.insert(0, os.path.join('..', 'proto', 'generated', 'python'))
          from todo.v1.todo_service_pb2_mcp import register_todo_service_mcp_handler
          print('Python generated code imports OK')
          "
      - name: Run smoke test
        working-directory: examples/python
        run: uv run python -m pytest smoke_test.py -v

  rust:
    name: Check (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - name: Cargo check
        working-directory: examples/rust
        run: cargo check --all-targets

  proto-python:
    name: Check proto lib (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Build & verify imports
        working-directory: mcp/protobuf/python
        run: |
          pip install .
          python -c "
          from mcp.protobuf import annotations_pb2
          from mcp.protobuf import app_pb2
          from mcp.protobuf import prompt_pb2
          from mcp.protobuf import elicitation_pb2
          from mcp.protobuf import resource_pb2
          from mcp.protobuf import field_type_pb2
          from mcp.protobuf import mime_type_pb2
          from mcp.protobuf import service_options_pb2
          print('All mcp.protobuf imports OK')
          "

  proto-rust:
    name: Check proto lib (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - name: Cargo check
        working-directory: mcp/protobuf/rust
        run: cargo check
